Ces services font partie de la couche Â«â€¯dâ€™accÃ¨s aux fonctionnalitÃ©sâ€¯Â» du frontend.
Ils encapsulent des fonctions utilitaires spÃ©cifiques, accessibles Ã  diffÃ©rents composants, pour :

    anchorService.ts â†’ capturer, prÃ©parer et envoyer les preuves dâ€™ancrage au backend.

    localHistoryService.ts â†’ gÃ©rer lâ€™historique local dâ€™archives de vols via localStorage.

1ï¸âƒ£ src/services/anchorService.ts
ğŸ¯ RÃ´le

PrÃ©pare et envoie au backend les donnÃ©es dâ€™ancrage dâ€™un vol, en gÃ©nÃ©rant une preuve image encapsulÃ©e dans un fichier ZIP.
ğŸ“¦ Fonctions principales
buildAnchorData(flight: Flight, description?: string): AnchorData

    But : CrÃ©er lâ€™objet JSON Ã  ancrer Ã  partir des infos de vol.

    Champs inclus :

        altitude, created_time, distance, id, latitude, longitude, name.

        description passÃ©e depuis lâ€™UI.

        anchored_at : timestamp ISO de la prÃ©paration.

    Important : la trace complÃ¨te nâ€™est pas incluse ici (elle est capturÃ©e en image sÃ©parÃ©ment).

captureMapImage(mapDiv?: HTMLElement | null, scale?: number): Promise<Blob | null>

    But : Produire une capture PNG de la carte Leaflet.

    Options :

        mapDiv : Ã©lÃ©ment DOM cible (sinon cherche .leaflet-container).

        scale haute rÃ©solution (dÃ©faut : 5 pour meilleure qualitÃ©).

    Retour : Blob PNG ou null si Ã©chec.

    Internals : utilise html2canvas avec useCORS et fond transparent.

generateImageZip(mapImageBlob: Blob): Promise<Blob>

    But : CrÃ©er un archive .zip contenant lâ€™image capturÃ©e.

    ImplÃ©mentation : via JSZip.

    Contenu : carte.png dans le ZIP.

    Retour : Blob du ZIP, prÃªt Ã  lâ€™envoi.

sendAnchorToBackend(anchorData: AnchorData, zipBlob: Blob): Promise<AnchorResponse>

    But : Uploader les mÃ©tadonnÃ©es JSON + fichier ZIP vers le backend (/anchor).

    Format : multipart/form-data (FormData).

        champ JSON â†’ "anchorData"

        champ fichier ZIP â†’ "proofZip"

    RÃ©ponse attendue : { folder?: string, message?: string, ... } indiquant le dossier dâ€™ancrage ou un message.

    Gestion dâ€™erreurs : vÃ©rifie statut HTTP et retourne le JSON, sinon lÃ¨ve une Error.

ğŸ“Œ Points Ã  retenir

    URL backend doit Ãªtre centralisÃ©e dans utils/constants.ts (ANCHOR_URL).

    Le nom des champs (anchorData, proofZip) doit correspondre exactement Ã  ce qui est attendu par le backend.

    VÃ©rifier que le ZIP nâ€™est pas vide avant envoi.

    PossibilitÃ© de personnaliser :

        le nom du fichier image dans le ZIP

        le nom du fichier ZIP

        le scale de capture

2ï¸âƒ£ src/services/localHistoryService.ts
ğŸ¯ RÃ´le

GÃ¨re localement, dans le navigateur, la liste des vols archivÃ©s Â«â€¯en cacheâ€¯Â» pour consultation hors ligne.
ğŸ“¦ Constantes importantes

    LOCAL_STORAGE_KEY = "droneweb_history" â†’ clÃ© unique cÃ´tÃ© storage.

    MAX_HISTORY_LENGTH = 100 â†’ taille maximale de lâ€™historique conservÃ©.

ğŸ“¦ Fonctions principales
getLocalHistory(): Flight[]

    But : Lire le contenu JSON sous LOCAL_STORAGE_KEY et le convertir en tableau de Flight.

    VÃ©rification : filtre via isFlight (valide id et created_time comme string).

    Retour : tableau de vols valides ou vide si absence/donnÃ©es invalides.

addToLocalHistory(flight: Flight): void

    But : Ajouter un vol Ã  lâ€™historique si non prÃ©sent.

    PrÃ©cautions :

        Si (id, created_time) dÃ©jÃ  prÃ©sent â†’ ignore.

        Ajoute en tÃªte de liste (unshift).

        Coupe Ã  MAX_HISTORY_LENGTH Ã©lÃ©ments.

    Sauvegarde : rÃ©Ã©crit totalement la clÃ© LOCAL_STORAGE_KEY au format JSON.

removeFromLocalHistory(id: string, created_time: string): void

    But : Supprimer un vol prÃ©cis de lâ€™historique.

    MÃ©canisme : filtre tous les vols dont (id, created_time) ne correspond pas.

clearLocalHistory(): void (ajout possible conseillÃ©)

    But : Vider complÃ¨tement lâ€™historique local.

    ImplÃ©mentation : localStorage.removeItem(LOCAL_STORAGE_KEY).

ğŸ“Œ Points Ã  retenir

    Les fonctions sont dÃ©terministes â†’ lâ€™Ã©tat en local est toujours cohÃ©rent.

    isFlight() est la garde de type pour Ã©viter stockage de donnÃ©es incorrectes.

    Ajout/lecture sont synchrone (rapiditÃ© du localStorage).

    Les logs peuvent Ãªtre conditionnÃ©s Ã  process.env.NODE_ENV === "development" pour Ã©viter la pollution console en prod.

    Limiter le nombre dâ€™Ã©lÃ©ments protÃ¨ge contre :

        lenteur dâ€™accÃ¨s localStorage

        surcharge mÃ©moire

        tailles de JSON excessives
        
ğŸ“Œ Conseil global :

    Toujours centraliser les URLs externes dans utils/constants.ts

    PrÃ©voir un flag global DEBUG pour tous les services afin de contrÃ´ler les logs depuis une seule variable.

    Les services sont faciles Ã  tester unitairement â†’ idÃ©al pour sÃ©curiser les futures Ã©volutions.
